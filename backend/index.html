<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión de Inventario</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 1200px;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
        }

        .header .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .login-container {
            padding: 50px;
            max-width: 450px;
            margin: 0 auto;
        }

        .login-container h2 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border 0.3s ease;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .link-button {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            text-decoration: underline;
            font-size: 14px;
            margin-top: 10px;
        }

        .link-button:hover {
            color: #5568d3;
        }

        .main-content {
            padding: 30px;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .nav-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .nav-tab:hover {
            color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .product-card {
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
            background: white;
        }

        .product-card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-5px);
        }

        .product-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .product-card .no-image {
            width: 100%;
            height: 200px;
            background: #f3f4f6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            margin-bottom: 10px;
        }

        .product-card h3 {
            font-size: 18px;
            color: #333;
            margin-bottom: 5px;
        }

        .product-card p {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .product-card .price {
            font-size: 20px;
            color: #10b981;
            font-weight: bold;
            margin: 10px 0;
        }

        .product-card .stock {
            font-size: 14px;
            color: #6b7280;
        }

        .product-card .actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #333;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .close-modal:hover {
            color: #333;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        .table tr:hover {
            background: #f9fafb;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .quantity-input {
            width: 60px;
            padding: 5px;
            text-align: center;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6b7280;
        }

        .image-preview {
            width: 100%;
            max-width: 300px;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-top: 10px;
        }

        .reports-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .report-card {
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 20px;
            background: #f9fafb;
        }

        .report-card h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .report-card p {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .container {
                border-radius: 0;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .products-grid {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen">
            <div class="login-container">
                <h2>Iniciar Sesión</h2>
                <div id="loginAlert"></div>

                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Correo Electrónico</label>
                        <input type="email" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Contraseña</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Iniciar Sesión</button>
                </form>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="link-button" onclick="showRegisterForm()">¿No tienes cuenta? Regístrate</button>
                    <br>
                    <button class="link-button" onclick="showPasswordResetForm()">¿Olvidaste tu contraseña?</button>
                </div>
            </div>
        </div>

        <!-- Register Screen -->
        <div id="registerScreen" class="hidden">
            <div class="login-container">
                <h2>Crear Cuenta</h2>
                <div id="registerAlert"></div>

                <form id="registerForm">
                    <div class="form-group">
                        <label for="registerName">Nombre</label>
                        <input type="text" id="registerName" required>
                    </div>
                    <div class="form-group">
                        <label for="registerEmail">Correo Electrónico</label>
                        <input type="email" id="registerEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">Contraseña</label>
                        <input type="password" id="registerPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Registrarse</button>
                </form>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="link-button" onclick="showLoginForm()">¿Ya tienes cuenta? Inicia sesión</button>
                </div>
            </div>
        </div>

        <!-- Password Reset Screen -->
        <div id="resetScreen" class="hidden">
            <div class="login-container">
                <h2>Recuperar Contraseña</h2>
                <div id="resetAlert"></div>

                <form id="resetRequestForm">
                    <div class="form-group">
                        <label for="resetEmail">Correo Electrónico</label>
                        <input type="email" id="resetEmail" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Enviar Enlace</button>
                </form>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="link-button" onclick="showLoginForm()">Volver al inicio de sesión</button>
                </div>
            </div>
        </div>

        <!-- Main App Screen -->
        <div id="mainScreen" class="hidden">
            <div class="header">
                <h1>Sistema de Gestión de Inventario</h1>
                <div class="user-info">
                    <span id="userName"></span>
                    <button class="btn btn-danger btn-sm" onclick="logout()">Cerrar Sesión</button>
                </div>
            </div>

            <div class="main-content">
                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="showTab('products')">Productos</button>
                    <button class="nav-tab" onclick="showTab('sales')">Realizar Venta</button>
                    <button class="nav-tab" onclick="showTab('inventory')">Gestión de Inventario</button>
                    <button class="nav-tab" onclick="showTab('reports')">Reportes</button>
                </div>

                <!-- Products Tab -->
                <div id="productsTab" class="tab-content active">
                    <h2>Catálogo de Productos</h2>
                    <div id="productsLoading" class="loading">Cargando productos...</div>
                    <div id="productsGrid" class="products-grid"></div>
                </div>

                <!-- Sales Tab -->
                <div id="salesTab" class="tab-content">
                    <h2>Realizar Venta</h2>
                    <div id="salesAlert"></div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px;">
                        <div>
                            <h3>Información del Cliente</h3>
                            <div class="form-group">
                                <label for="customerSelect">Seleccionar Cliente</label>
                                <select id="customerSelect">
                                    <option value="">Cliente Anónimo</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="customerNameInput">O ingrese nombre</label>
                                <input type="text" id="customerNameInput" placeholder="Nombre del cliente">
                            </div>
                            <button class="btn btn-secondary" onclick="showNewCustomerModal()">+ Nuevo Cliente</button>

                            <h3 style="margin-top: 30px;">Productos Disponibles</h3>
                            <div id="salesProductsList"></div>
                        </div>

                        <div>
                            <h3>Carrito de Compra</h3>
                            <div id="cartItems"></div>
                            <div style="margin-top: 20px; padding: 20px; background: #f9fafb; border-radius: 8px;">
                                <h3>Total: $<span id="cartTotal">0.00</span></h3>
                                <button class="btn btn-success" style="width: 100%; margin-top: 10px;" onclick="completeSale()">Completar Venta</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Inventory Management Tab -->
                <div id="inventoryTab" class="tab-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Gestión de Inventario</h2>
                        <button class="btn btn-success" onclick="showProductModal()">+ Nuevo Producto</button>
                    </div>
                    <div id="inventoryAlert"></div>
                    <div id="inventoryLoading" class="loading">Cargando inventario...</div>
                    <table class="table" id="inventoryTable">
                        <thead>
                            <tr>
                                <th>Imagen</th>
                                <th>Nombre</th>
                                <th>Descripción</th>
                                <th>Precio</th>
                                <th>Stock</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody"></tbody>
                    </table>
                </div>

                <!-- Reports Tab -->
                <div id="reportsTab" class="tab-content">
                    <h2>Reportes</h2>
                    <div class="reports-section">
                        <div class="report-card">
                            <h3>Reporte de Ventas</h3>
                            <p>Genera un reporte completo con el valor total de todas las ventas realizadas.</p>
                            <button class="btn btn-primary" onclick="generateSalesReport()">Descargar XLSX</button>
                        </div>

                        <div class="report-card">
                            <h3>Reporte de Stock</h3>
                            <p>Genera un reporte con el total de productos en stock y su valor.</p>
                            <button class="btn btn-primary" onclick="generateStockReport()">Descargar XLSX</button>
                        </div>

                        <div class="report-card">
                            <h3>Compras por Cliente</h3>
                            <p>Genera un reporte de compras de un cliente específico.</p>
                            <div class="form-group">
                                <label for="reportCustomerSelect">Seleccionar Cliente</label>
                                <select id="reportCustomerSelect">
                                    <option value="">Seleccione un cliente</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="generateCustomerReport()">Descargar XLSX</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="productModalTitle">Nuevo Producto</h2>
                <button class="close-modal" onclick="closeProductModal()">&times;</button>
            </div>
            <div id="productModalAlert"></div>
            <form id="productForm">
                <input type="hidden" id="productId">
                <div class="form-group">
                    <label for="productName">Nombre del Producto</label>
                    <input type="text" id="productName" required>
                </div>
                <div class="form-group">
                    <label for="productDescription">Descripción</label>
                    <textarea id="productDescription"></textarea>
                </div>
                <div class="form-group">
                    <label for="productPrice">Precio</label>
                    <input type="number" id="productPrice" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="productStock">Stock</label>
                    <input type="number" id="productStock" required>
                </div>
                <div class="form-group">
                    <label for="productPhoto">Imagen del Producto</label>
                    <input type="file" id="productPhoto" accept="image/*" onchange="previewImage()">
                    <img id="imagePreview" class="image-preview hidden">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">Guardar</button>
                    <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeProductModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Customer Modal -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nuevo Cliente</h2>
                <button class="close-modal" onclick="closeCustomerModal()">&times;</button>
            </div>
            <div id="customerModalAlert"></div>
            <form id="customerForm">
                <div class="form-group">
                    <label for="customerName">Nombre</label>
                    <input type="text" id="customerName" required>
                </div>
                <div class="form-group">
                    <label for="customerEmail">Correo Electrónico</label>
                    <input type="email" id="customerEmail">
                </div>
                <div class="form-group">
                    <label for="customerPhone">Teléfono</label>
                    <input type="text" id="customerPhone">
                </div>
                <div class="form-group">
                    <label for="customerAddress">Dirección</label>
                    <textarea id="customerAddress"></textarea>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">Guardar</button>
                    <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeCustomerModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:4000/api';
        let authToken = localStorage.getItem('authToken');
        let currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
        let products = [];
        let customers = [];
        let cart = [];
        let editingProductId = null;

        // Initialize app
        window.onload = function() {
            if (authToken && currentUser) {
                showMainApp();
            }
        };

        // Authentication Functions
        function showLoginForm() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('registerScreen').classList.add('hidden');
            document.getElementById('resetScreen').classList.add('hidden');
        }

        function showRegisterForm() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('registerScreen').classList.remove('hidden');
            document.getElementById('resetScreen').classList.add('hidden');
        }

        function showPasswordResetForm() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('registerScreen').classList.add('hidden');
            document.getElementById('resetScreen').classList.remove('hidden');
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                if (response.ok) {
                    authToken = data.token;
                    currentUser = data.user;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    showMainApp();
                } else {
                    showAlert('loginAlert', data.message, 'error');
                }
            } catch (error) {
                showAlert('loginAlert', 'Error al conectar con el servidor', 'error');
            }
        });

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;

            try {
                const response = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password })
                });

                const data = await response.json();
                if (response.ok) {
                    showAlert('registerAlert', 'Cuenta creada exitosamente. Inicia sesión.', 'success');
                    setTimeout(() => showLoginForm(), 2000);
                } else {
                    showAlert('registerAlert', data.message, 'error');
                }
            } catch (error) {
                showAlert('registerAlert', 'Error al conectar con el servidor', 'error');
            }
        });

        document.getElementById('resetRequestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('resetEmail').value;

            try {
                const response = await fetch(`${API_URL}/auth/request-reset`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                const data = await response.json();
                if (response.ok) {
                    showAlert('resetAlert', 'Se ha enviado un enlace de recuperación a tu correo', 'success');
                } else {
                    showAlert('resetAlert', data.message, 'error');
                }
            } catch (error) {
                showAlert('resetAlert', 'Error al conectar con el servidor', 'error');
            }
        });

        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            document.getElementById('mainScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            cart = [];
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');
            document.getElementById('userName').textContent = currentUser.name || currentUser.email;
            loadProducts();
            loadCustomers();
        }

        // Tab Navigation
        function showTab(tabName) {
            const tabs = document.querySelectorAll('.nav-tab');
            const contents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');

            if (tabName === 'products') {
                loadProducts();
            } else if (tabName === 'inventory') {
                loadInventory();
            } else if (tabName === 'sales') {
                loadSalesProducts();
                loadCustomersForSales();
            } else if (tabName === 'reports') {
                loadCustomersForReports();
            }
        }

        // Products Functions
        async function loadProducts() {
            document.getElementById('productsLoading').classList.remove('hidden');
            try {
                const response = await fetch(`${API_URL}/products`);
                products = await response.json();
                displayProducts(products);
            } catch (error) {
                console.error('Error loading products:', error);
            }
            document.getElementById('productsLoading').classList.add('hidden');
        }

        function displayProducts(productsData) {
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = '';

            productsData.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';

                const imageHtml = product.photoBase64 ?
                    `<img src="${product.photoBase64}" alt="${product.name}">` :
                    '<div class="no-image">Sin imagen</div>';

                card.innerHTML = `
                    ${imageHtml}
                    <h3>${product.name}</h3>
                    <p>${product.description || 'Sin descripción'}</p>
                    <div class="price">$${product.price.toFixed(2)}</div>
                    <div class="stock">Stock: ${product.stock} unidades</div>
                `;
                grid.appendChild(card);
            });
        }

        // Inventory Management
        async function loadInventory() {
            document.getElementById('inventoryLoading').classList.remove('hidden');
            try {
                const response = await fetch(`${API_URL}/products`);
                products = await response.json();
                displayInventory(products);
            } catch (error) {
                console.error('Error loading inventory:', error);
            }
            document.getElementById('inventoryLoading').classList.add('hidden');
        }

        function displayInventory(productsData) {
            const tbody = document.getElementById('inventoryTableBody');
            tbody.innerHTML = '';

            productsData.forEach(product => {
                const row = document.createElement('tr');

                const imageHtml = product.photoBase64 ?
                    `<img src="${product.photoBase64}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 5px;">` :
                    '<div style="width: 60px; height: 60px; background: #f3f4f6; border-radius: 5px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #999;">Sin foto</div>';

                row.innerHTML = `
                    <td>${imageHtml}</td>
                    <td>${product.name}</td>
                    <td>${product.description || '-'}</td>
                    <td>$${product.price.toFixed(2)}</td>
                    <td>${product.stock}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editProduct('${product.id}')">Editar</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteProduct('${product.id}')">Eliminar</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function showProductModal() {
            editingProductId = null;
            document.getElementById('productModalTitle').textContent = 'Nuevo Producto';
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('productModal').classList.add('active');
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.remove('active');
            document.getElementById('productModalAlert').innerHTML = '';
        }

        async function editProduct(productId) {
            try {
                const response = await fetch(`${API_URL}/products/${productId}`);
                const product = await response.json();

                editingProductId = productId;
                document.getElementById('productModalTitle').textContent = 'Editar Producto';
                document.getElementById('productId').value = productId;
                document.getElementById('productName').value = product.name;
                document.getElementById('productDescription').value = product.description || '';
                document.getElementById('productPrice').value = product.price;
                document.getElementById('productStock').value = product.stock;

                if (product.photoBase64) {
                    document.getElementById('imagePreview').src = product.photoBase64;
                    document.getElementById('imagePreview').classList.remove('hidden');
                }

                document.getElementById('productModal').classList.add('active');
            } catch (error) {
                console.error('Error loading product:', error);
            }
        }

        async function deleteProduct(productId) {
            if (!confirm('¿Está seguro de eliminar este producto?')) return;

            try {
                const response = await fetch(`${API_URL}/products/${productId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    showAlert('inventoryAlert', 'Producto eliminado exitosamente', 'success');
                    loadInventory();
                } else {
                    const data = await response.json();
                    showAlert('inventoryAlert', data.message, 'error');
                }
            } catch (error) {
                showAlert('inventoryAlert', 'Error al eliminar producto', 'error');
            }
        }

        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData();
            formData.append('name', document.getElementById('productName').value);
            formData.append('description', document.getElementById('productDescription').value);
            formData.append('price', document.getElementById('productPrice').value);
            formData.append('stock', document.getElementById('productStock').value);

            const photoFile = document.getElementById('productPhoto').files[0];
            if (photoFile) {
                formData.append('photo', photoFile);
            }

            try {
                const url = editingProductId ?
                    `${API_URL}/products/${editingProductId}` :
                    `${API_URL}/products`;
                const method = editingProductId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Authorization': `Bearer ${authToken}` },
                    body: formData
                });

                const data = await response.json();
                if (response.ok) {
                    showAlert('productModalAlert', editingProductId ? 'Producto actualizado' : 'Producto creado', 'success');
                    setTimeout(() => {
                        closeProductModal();
                        loadInventory();
                    }, 1500);
                } else {
                    showAlert('productModalAlert', data.message, 'error');
                }
            } catch (error) {
                showAlert('productModalAlert', 'Error al guardar producto', 'error');
            }
        });

        function previewImage() {
            const file = document.getElementById('productPhoto').files[0];
            const preview = document.getElementById('imagePreview');

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        // Customers Functions
        async function loadCustomers() {
            try {
                const response = await fetch(`${API_URL}/customers`);
                customers = await response.json();
            } catch (error) {
                console.error('Error loading customers:', error);
            }
        }

        function loadCustomersForSales() {
            const select = document.getElementById('customerSelect');
            select.innerHTML = '<option value="">Cliente Anónimo</option>';
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.name;
                select.appendChild(option);
            });
        }

        function loadCustomersForReports() {
            const select = document.getElementById('reportCustomerSelect');
            select.innerHTML = '<option value="">Seleccione un cliente</option>';
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.name;
                select.appendChild(option);
            });
        }

        function showNewCustomerModal() {
            document.getElementById('customerModal').classList.add('active');
        }

        function closeCustomerModal() {
            document.getElementById('customerModal').classList.remove('active');
            document.getElementById('customerForm').reset();
            document.getElementById('customerModalAlert').innerHTML = '';
        }

        document.getElementById('customerForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const customerData = {
                name: document.getElementById('customerName').value,
                email: document.getElementById('customerEmail').value,
                phone: document.getElementById('customerPhone').value,
                address: document.getElementById('customerAddress').value
            };

            try {
                const response = await fetch(`${API_URL}/customers`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(customerData)
                });

                const data = await response.json();
                if (response.ok) {
                    showAlert('customerModalAlert', 'Cliente creado exitosamente', 'success');
                    await loadCustomers();
                    loadCustomersForSales();
                    setTimeout(() => {
                        closeCustomerModal();
                        document.getElementById('customerSelect').value = data.id;
                    }, 1500);
                } else {
                    showAlert('customerModalAlert', data.message, 'error');
                }
            } catch (error) {
                showAlert('customerModalAlert', 'Error al crear cliente', 'error');
            }
        });

        // Sales Functions
        async function loadSalesProducts() {
            try {
                const response = await fetch(`${API_URL}/products`);
                const products = await response.json();
                displaySalesProducts(products);
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        function displaySalesProducts(productsData) {
            const list = document.getElementById('salesProductsList');
            list.innerHTML = '';

            productsData.forEach(product => {
                if (product.stock > 0) {
                    const item = document.createElement('div');
                    item.className = 'cart-item';
                    item.innerHTML = `
                        <div class="cart-item-info">
                            <strong>${product.name}</strong><br>
                            <span>$${product.price.toFixed(2)} | Stock: ${product.stock}</span>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="addToCart('${product.id}')">Agregar</button>
                    `;
                    list.appendChild(item);
                }
            });
        }

        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const cartItem = cart.find(item => item.productId === productId);
            if (cartItem) {
                if (cartItem.quantity < product.stock) {
                    cartItem.quantity++;
                } else {
                    alert('No hay suficiente stock');
                    return;
                }
            } else {
                cart.push({
                    productId: product.id,
                    name: product.name,
                    price: product.price,
                    quantity: 1,
                    maxStock: product.stock
                });
            }

            displayCart();
        }

        function displayCart() {
            const cartContainer = document.getElementById('cartItems');
            cartContainer.innerHTML = '';

            if (cart.length === 0) {
                cartContainer.innerHTML = '<p>El carrito está vacío</p>';
                document.getElementById('cartTotal').textContent = '0.00';
                return;
            }

            let total = 0;
            cart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;

                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                cartItem.innerHTML = `
                    <div class="cart-item-info">
                        <strong>${item.name}</strong><br>
                        <span>$${item.price.toFixed(2)} x ${item.quantity} = $${itemTotal.toFixed(2)}</span>
                    </div>
                    <div class="cart-item-actions">
                        <input type="number" class="quantity-input" min="1" max="${item.maxStock}"
                               value="${item.quantity}" onchange="updateCartQuantity(${index}, this.value)">
                        <button class="btn btn-danger btn-sm" onclick="removeFromCart(${index})">✕</button>
                    </div>
                `;
                cartContainer.appendChild(cartItem);
            });

            document.getElementById('cartTotal').textContent = total.toFixed(2);
        }

        function updateCartQuantity(index, newQuantity) {
            const quantity = parseInt(newQuantity);
            if (quantity > 0 && quantity <= cart[index].maxStock) {
                cart[index].quantity = quantity;
                displayCart();
            } else {
                alert('Cantidad inválida');
                displayCart();
            }
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            displayCart();
        }

        async function completeSale() {
            if (cart.length === 0) {
                showAlert('salesAlert', 'El carrito está vacío', 'error');
                return;
            }

            const customerId = document.getElementById('customerSelect').value;
            const customerName = document.getElementById('customerNameInput').value ||
                                 (customerId ? customers.find(c => c.id === customerId)?.name : 'Cliente Anónimo');

            const saleData = {
                customerId: customerId || undefined,
                customerName: customerName,
                items: cart.map(item => ({
                    productId: item.productId,
                    quantity: item.quantity
                }))
            };

            try {
                const response = await fetch(`${API_URL}/sales`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(saleData)
                });

                const data = await response.json();
                if (response.ok) {
                    showAlert('salesAlert', `Venta realizada exitosamente. Total: $${data.total.toFixed(2)}`, 'success');

                    // Download invoice
                    window.open(`${API_URL}/sales/${data.saleId}/invoice`, '_blank');

                    // Clear cart
                    cart = [];
                    displayCart();
                    document.getElementById('customerNameInput').value = '';
                    document.getElementById('customerSelect').value = '';
                    loadSalesProducts();
                } else {
                    showAlert('salesAlert', data.message, 'error');
                }
            } catch (error) {
                showAlert('salesAlert', 'Error al realizar la venta', 'error');
            }
        }

        // Reports Functions
        async function generateSalesReport() {
            try {
                const response = await fetch(`${API_URL}/reports/sales-total`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `reporte_ventas_${new Date().toISOString().slice(0,10)}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('Error al generar reporte de ventas');
                }
            } catch (error) {
                alert('Error al generar reporte de ventas');
            }
        }

        async function generateStockReport() {
            try {
                const response = await fetch(`${API_URL}/reports/stock`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `reporte_stock_${new Date().toISOString().slice(0,10)}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('Error al generar reporte de stock');
                }
            } catch (error) {
                alert('Error al generar reporte de stock');
            }
        }

        async function generateCustomerReport() {
            const customerId = document.getElementById('reportCustomerSelect').value;
            if (!customerId) {
                alert('Debe seleccionar un cliente');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/reports/customer-purchases/${customerId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `compras_cliente_${customerId}_${new Date().toISOString().slice(0,10)}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('Error al generar reporte de cliente');
                }
            } catch (error) {
                alert('Error al generar reporte de cliente');
            }
        }

        // Utility Functions
        function showAlert(elementId, message, type) {
            const alertDiv = document.getElementById(elementId);
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 5000);
        }
    </script>
</body>
</html>
